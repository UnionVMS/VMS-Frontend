<div class="realtime-container">
  <div class="loading-overlay"  *ngIf="!mapReady && !mapSettingsLoaded">
    <h2 i18n>Loading asset positions</h2>
    <mat-spinner class="load-spinner"></mat-spinner>
  </div>
  <map-left-column
    [centerMapOnPosition]="centerMapOnPosition"
    [hideLeftColumn]="hideLeftColumn"
    [columnHidden]="leftColumnHidden"
  ></map-left-column>
  <div class="map-container {{ rightColumnHidden ? 'map-right-column-hidden' : '' }} {{ leftColumnHidden ? 'map-left-column-hidden' : '' }}">
    <div id="realtime-map"></div>
    <ng-container *ngIf="mapReady && mapSettingsLoaded">
      <map-right-click-menu
        [map]="map"
        [addOverlay]="addOverlay"
        [moveOverlay]="moveOverlay"
        [removeOverlay]="removeOverlay"
        [registerOnClickFunction]="registerOnClickFunction"
        [unregisterOnClickFunction]="unregisterOnClickFunction"
      ></map-right-click-menu>
      <map-assets
        *ngIf="registerOnSelectFunction !== undefined"
        [assets]="assetMovements"
        [selectedAssets]="selectedAssets"
        [map]="map"
        [mapZoom]="mapZoom"
        [namesVisible]="mapSettings.settings.namesVisible"
        [speedsVisible]="mapSettings.settings.speedsVisible"
        [selectAsset]="selectAsset"
        [deselectAsset]="deselectAsset"
        [shipColorLogic]="mapSettings.settings.assetColorMethod"
        [registerOnSelectFunction]="registerOnSelectFunction"
        [unregisterOnSelectFunction]="unregisterOnSelectFunction"
      ></map-assets>
      <map-tracks-segments
        *ngIf="mapSettings.settings.tracksVisible"
        [assetTracks]="assetTracks$|async"
        [map]="map"
      ></map-tracks-segments>
      <map-tracks
        *ngIf="mapSettings.settings.tracksVisible && mapZoom > 5"
        [assetTracks]="assetTracks$|async"
        [map]="map"
        [registerOnClickFunction]="registerOnClickFunction"
        [unregisterOnClickFunction]="unregisterOnClickFunction"
      ></map-tracks>
      <map-flagstates
        *ngIf="mapSettings.settings.flagsVisible && mapZoom > 9 && registerOnSelectFunction !== undefined"
        [assets]="assetMovements"
        [map]="map"
        [selectAsset]="selectAsset"
        [registerOnSelectFunction]="registerOnSelectFunction"
        [unregisterOnSelectFunction]="unregisterOnSelectFunction"
      ></map-flagstates>
      <map-asset-forecast
        *ngIf="mapSettings.settings.forecastsVisible && mapZoom > 9"
        [map]="map"
        [assetMovements]="forecasts$|async"
        [forecastInterval]="mapSettings.settings.forecastInterval"
      ></map-asset-forecast>
      <div class="control-panel">
        <ul class="control-panel-menu">
          <li>
            <i
              (click)="toggleActivePanel('map-layers')"
              title="Map layers."
              class="icon-map-layers {{activePanel === 'map-layers' ? 'active' : '' }}"
              aria-hidden="true"
            ></i>
            <div class="control-panel-submenu">
              <map-layers
                *ngIf="(authToken$ | async) !== undefined && (mapLayers$ | async).length > 0"
                [map]="map"
                [authToken]="authToken$ | async"
                [mapLayers]="mapLayers$ | async"
                [activeMapLayers]="activeMapLayers$ | async"
                [menuActive]="activePanel === 'map-layers'"
                [addActiveLayerFunction]="addActiveLayer"
                [removeActiveLayerFunction]="removeActiveLayer"
              ></map-layers>
            </div>
          </li>
          <li>
            <i
              (click)="toggleActivePanel('distance-between-points')"
              title="Messure distance."
              class="icon-distance-between-points {{activePanel === 'distance-between-points' ? 'active' : '' }}"
              aria-hidden="true"
            ></i>
            <div class="control-panel-submenu">
              <map-distance-between-points
                [map]="map"
                [registerOnClickFunction]="registerOnClickFunction"
                [active]="activePanel === 'distance-between-points'"
                [unitOfDistance]="mapSettings.settings.unitOfDistance"
              ></map-distance-between-points>
            </div>
          </li>
          <li>
            <i
              (click)="toggleActivePanel('asset-layers')"
              title="Hide and show asset infromation on map."
              class="icon-asset-layers {{activePanel === 'asset-layers' ? 'active' : '' }}"
              aria-hidden="true"
            ></i>
            <div class="control-panel-submenu">
              <map-layer-filter
                *ngIf="activePanel === 'asset-layers'"
                [mapSettings]="mapSettings"
                [setVisibilityForAssetNames]="setVisibilityForAssetNames"
                [setVisibilityForAssetSpeeds]="setVisibilityForAssetSpeeds"
                [setVisibilityForFlags]="setVisibilityForFlags"
                [setVisibilityForTracks]="setVisibilityForTracks"
                [setVisibilityForForecast]="setVisibilityForForecast"
                [flagsDisabled]="mapZoom < 10"
                [tracksDisabled]="false"
                [namesDisabled]="mapZoom < 10"
                [speedsDisabled]="mapZoom < 10"
                [forecastsDisabled]="mapZoom < 10"
              ></map-layer-filter>
            </div>
          </li>
          <li>
            <i
              (click)="toggleActivePanel('map-locations')"
              title="Saved map positions."
              class="icon-map-locations {{activePanel === 'map-locations' ? 'active' : '' }}"
              aria-hidden="true"
            ></i>
            <div class="control-panel-submenu" *ngIf="mapSettings">
              <map-locations
                [menuActive]="activePanel === 'map-locations'"
                [centerMapOnPosition]="centerMapOnPosition"
                [mapLocations]="mapSettings.mapLocations"
                [map]="map"
                [saveMapLocation]="saveMapLocation"
              ></map-locations>
            </div>
          </li>
          <li>
            <i
              (click)="centerOnDefaultPosition()"
              title="Back to chosen start position."
              class="icon-center-sweden"
              aria-hidden="true"
            ></i>
          </li>
          <li>
            <i
              (click)="toggleActivePanel('pick-source')"
              title="Pick source"
              class="ri-base-station-line icon {{activePanel === 'pick-source' ? 'active' : '' }}"
              aria-hidden="true"
            ></i>
            <div class="control-panel-submenu" *ngIf="mapSettings">
              <map-source-picker
                [menuActive]="activePanel === 'pick-source'"
                [setSourceFunction]="setChoosenMovementSources"
                [movementSources]="movementSources$ | async"
                [choosenMovementSources]="choosenMovementSources$ | async"
              ></map-source-picker>
            </div>
          </li>
        </ul>
      </div>
    </ng-container>
  </div>
  <map-right-column
    [centerMapOnPosition]="centerMapOnPosition"
    [map]="map"
    [hideRightColumn]="hideRightColumn"
    [columnHidden]="rightColumnHidden"
  ></map-right-column>
</div>
